<!DOCTYPE html><!--<Content />--><html lang="en"><head><meta charset="UTF-8"><meta name="description" content="neewbee's blog"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link href="/output.css" rel="stylesheet"><meta name="generator" content="Astro v3.4.0"><title>A glimpse of refraction and dispersion in Computer Graphics</title><link rel="stylesheet" href="/_astro/about-me.c71ca1a0.css" /></head><!-- ><--><body class="bg-white dark:bg-gray-900"><div class="min-h-screen max-w-5xl mx-auto w-11/12"><div class="max-w-3xl m-auto w-11/12 font-mono dark:text-white text-l text-black flex flex-col items-center"><div class="prose dark:prose-invert prose-slate flex items-center flex-col w-full"><div class="text-2xl m-6 text-clip">A glimpse of refraction and dispersion in Computer Graphics</div><div class="w-full"><p class="prose dark:prose-invert prose-slate flex flex-row items-center"><p>For a long time, I am very curious about Three.js, WebGL. But, it always
feel overwhelming to me. I have tried
<a href="https://webglfundamentals.org/">WebGL Fundamentals</a> before,but somehow I couldn’t persist because there
were always some areas I didn’t understand, mainly linear algebra.</p></p><img src="/refraction-and-dispersion-in-three-js/twitter-01.png" alt=""/><p><p>About a year ago, I see some very impressive demos on Twitter.</p><figure><video src="/refraction-and-dispersion-in-three-js/demo-01.mp4" autoPlay loop class=" my-2 mx-auto"></video><figcaption class="mt-2 text-sm text-center text-gray-500 dark:text-gray-400 break-all"><p><a href="https://x.com/Damian_Kidd/status/1698675519523365090">https://x.com/Damian_Kidd/status/1698675519523365090</a></p></figcaption></figure><p>This was a C4D project. Later, the author of R3F posted a demo that blew my mind.</p><figure><video src="/refraction-and-dispersion-in-three-js/demo-02.mp4" autoPlay loop class="my-2 mx-auto"></video><figcaption class="mt-2 text-sm text-center text-gray-500 dark:text-gray-400 break-all"><p><a href="https://x.com/0xca0a/status/1698798813517942924">https://x.com/0xca0a/status/1698798813517942924</a></p></figcaption></figure><p>I began to dig into the source code and soon realized I had to learn the fundamentals of WebGL. So I decided to give
it another try. I followed the <a href="https://webglfundamentals.org/">WebGL Fundamentals</a> articles and typed
all the code. After reading “2D translation, rotation, scale, matrix math,” I decided to pick up linear algebra.
Fortunately, there are tons of learning materials about linear algebra, such as <a href="https://textbooks.math.gatech.edu/ila/index.html">textbooks.math.gatech.edu</a> and <a href="https://immersivemath.com/ila/index.html">immersivemath</a>. I often referred to another website when I felt
confused. After about a month, I thought I was ready to continue my WebGL fundamentals journey, so I started to read
the R3F source code. After lots of ChatGPT-ing and googling, I decided to write an article. Maybe this will give me
a better understanding.</p><blockquote>
<p>Teaching is the highest form of understanding</p>
</blockquote><h2>The most simple case 2d refraction</h2><p>Consider a 2D plane and a background. What will it look like when viewed through the 2D plane? The first thing that
comes to mind is refraction. Light bends when traveling through different materials.</p><image class="m-auto" src="/refraction-and-dispersion-in-three-js/refraction.svg"></image><p>This is a great article written by <a href="https://blog.maximeheckel.com/">Maxime</a>. You can play this demo by
clicking the link in the description. There are only a glass and an object. So, how do we solve this? Simple!</p><ul>
<li>render the scene without the <em>glass</em> and save the render data</li>
<li>pass the image data to <em>glass</em> mesh shader and calculate the final color output</li>
<li>render the <em>glass</em></li>
</ul><figure><image src="/refraction-and-dispersion-in-three-js/dispersion-effect.png" class="w-4/4 my-2 mx-auto"></image><figcaption class="mt-2 text-sm text-center text-gray-500 dark:text-gray-400"><p><a href="https://neewbee.github.io/dispersion-effect/">https://neewbee.github.io/dispersion-effect/</a> (final result)</p></figcaption></figure><p>Here is a code snippet taken from <a href="https://blog.maximeheckel.com/">Maxime</a>.</p><div data-rehype-pretty-code-fragment=""><pre class="dracula" style="background-color:#282A36" tabindex="0" data-language="tsx" data-theme="default"><code data-line-numbers="" data-language="tsx" data-theme="default" style="display:grid" data-line-numbers-max-digits="2"><span data-line=""><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> { gl, scene, camera } </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> state;</span></span>
<span data-line=""><span style="color:#6272A4">//  render the scene without the *glass*</span></span>
<span data-line=""><span style="color:#F8F8F2">mesh.current.visible </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">false</span><span style="color:#F8F8F2">;</span></span>
<span data-line=""><span style="color:#F8F8F2">gl.</span><span style="color:#50FA7B">setRenderTarget</span><span style="color:#F8F8F2">(mainRenderTarget);</span></span>
<span data-line=""><span style="color:#6272A4">// and save the render data</span></span>
<span data-line=""><span style="color:#F8F8F2">gl.</span><span style="color:#50FA7B">render</span><span style="color:#F8F8F2">(scene, camera);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6272A4">// pass the image data to *glass* mesh shader and calculate the final color output</span></span>
<span data-line=""><span style="color:#F8F8F2">mesh.current.material.uniforms.uTexture.value </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> mainRenderTarget.texture;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">gl.</span><span style="color:#50FA7B">setRenderTarget</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">null</span><span style="color:#F8F8F2">);</span></span>
<span data-line=""><span style="color:#6272A4">// render the *glass*</span></span>
<span data-line=""><span style="color:#F8F8F2">mesh.current.visible </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">true</span><span style="color:#F8F8F2">;</span></span></code></pre></div><p>Steps 1 and 3 are easy to understand. Step 2 is where the magic happens. After applying the refraction effect in
shaders, you can see that we have a refraction effect.</p><image class="m-auto" src="/refraction-and-dispersion-in-three-js/step-1.0.png" alt="Refraction Step 1"></image><p>The next step is to make this more realistic. What we could do includes:</p><p><h3>dispersion</h3>
Because white light is a combination of all colors in the spectrum, in the fragment shader, calculate each RGB
channel with different IOR values.</p><image class="m-auto" src="/refraction-and-dispersion-in-three-js/dispersion.png"></image><div data-rehype-pretty-code-fragment=""><pre class="dracula" style="background-color:#282A36" tabindex="0" data-language="glsl" data-theme="default"><code data-language="glsl" data-theme="default" style="display:grid"><span data-line=""><span style="color:#FF79C6">uniform</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> uIorR;</span></span>
<span data-line=""><span style="color:#FF79C6">uniform</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> uIorG;</span></span>
<span data-line=""><span style="color:#FF79C6">uniform</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> uIorB;</span></span>
<span data-line=""><span style="color:#6272A4">//...</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">void</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">main</span><span style="color:#F8F8F2">() {</span></span>
<span data-line=""><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> iorRatioRed </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">1.0</span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2">uIorR;</span></span>
<span data-line=""><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> iorRatioGreen </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">1.0</span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2">uIorG;</span></span>
<span data-line=""><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> iorRatioBlue </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">1.0</span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2">uIorB;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">  vec3 color </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">vec3</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">1.0</span><span style="color:#F8F8F2">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">  vec2 uv </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> gl_FragCoord.xy </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> winResolution.xy;</span></span>
<span data-line=""><span style="color:#F8F8F2">  vec3 normal </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> worldNormal;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">  vec3 refractVecR </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">refract</span><span style="color:#F8F8F2">(eyeVector, normal, iorRatioRed);</span></span>
<span data-line=""><span style="color:#F8F8F2">  vec3 refractVecG </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">refract</span><span style="color:#F8F8F2">(eyeVector, normal, iorRatioGreen);</span></span>
<span data-line=""><span style="color:#F8F8F2">  vec3 refractVecB </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">refract</span><span style="color:#F8F8F2">(eyeVector, normal, iorRatioBlue);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> R </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">texture2D</span><span style="color:#F8F8F2">(uTexture, uv </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> refractVecR.xy).r;</span></span>
<span data-line=""><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> G </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">texture2D</span><span style="color:#F8F8F2">(uTexture, uv </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> refractVecG.xy).g;</span></span>
<span data-line=""><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> B </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">texture2D</span><span style="color:#F8F8F2">(uTexture, uv </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> refractVecB.xy).b;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">  color.r </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> R;</span></span>
<span data-line=""><span style="color:#F8F8F2">  color.g </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> G;</span></span>
<span data-line=""><span style="color:#F8F8F2">  color.b </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> B;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">  gl_FragColor </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">vec4</span><span style="color:#F8F8F2">(color, </span><span style="color:#BD93F9">1.0</span><span style="color:#F8F8F2">);</span></span>
<span data-line=""><span style="color:#F8F8F2">}</span></span></code></pre></div><p><h3>multiple sampling</h3>
In real life, light is a contains all wavelengths of light in a certain range, but we only use RGB. So to make it
more realistic, make a loop, and in each loop, and an offset so the output looks <i>smooth</i></p><div data-rehype-pretty-code-fragment=""><pre class="dracula" style="background-color:#282A36" tabindex="0" data-language="glsl" data-theme="default"><code data-language="glsl" data-theme="default" style="display:grid"><span data-line=""><span style="color:#FF79C6">uniform</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> uRefractPower;</span></span>
<span data-line=""><span style="color:#FF79C6">uniform</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> uChromaticAberration;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6272A4">// ...</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">vec3</span><span style="color:#F8F8F2"> color </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">vec3</span><span style="color:#F8F8F2">(</span><span style="color:#BD93F9">0.0</span><span style="color:#F8F8F2">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#FF79C6">for</span><span style="color:#F8F8F2"> ( </span><span style="color:#FF79C6">int</span><span style="color:#F8F8F2"> i </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">; i </span><span style="color:#FF79C6">&lt;</span><span style="color:#F8F8F2"> LOOP; i </span><span style="color:#FF79C6">++</span><span style="color:#F8F8F2"> ) {</span></span>
<span data-line=""><span style="color:#F8F8F2">  </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2"> slide </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2">(i) </span><span style="color:#FF79C6">/</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2">(LOOP) </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">0.1</span><span style="color:#F8F8F2">;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">  vec3 refractVecR </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">refract</span><span style="color:#F8F8F2">(eyeVector, normal, iorRatioRed);</span></span>
<span data-line=""><span style="color:#F8F8F2">  vec3 refractVecG </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">refract</span><span style="color:#F8F8F2">(eyeVector, normal, iorRatioGreen);</span></span>
<span data-line=""><span style="color:#F8F8F2">  vec3 refractVecB </span><span style="color:#FF79C6">=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">refract</span><span style="color:#F8F8F2">(eyeVector, normal, iorRatioBlue);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#F8F8F2">  color.r </span><span style="color:#FF79C6">+=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">texture2D</span><span style="color:#F8F8F2">(uTexture, uv </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> refractVecR.xy </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> (uRefractPower </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> slide </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">1.0</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> uChromaticAberration).r;</span></span>
<span data-line=""><span style="color:#F8F8F2">  color.g </span><span style="color:#FF79C6">+=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">texture2D</span><span style="color:#F8F8F2">(uTexture, uv </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> refractVecG.xy </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> (uRefractPower </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> slide </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">2.0</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> uChromaticAberration).g;</span></span>
<span data-line=""><span style="color:#F8F8F2">  color.b </span><span style="color:#FF79C6">+=</span><span style="color:#F8F8F2"> </span><span style="color:#50FA7B">texture2D</span><span style="color:#F8F8F2">(uTexture, uv </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> refractVecB.xy </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> (uRefractPower </span><span style="color:#FF79C6">+</span><span style="color:#F8F8F2"> slide </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> </span><span style="color:#BD93F9">3.0</span><span style="color:#F8F8F2">) </span><span style="color:#FF79C6">*</span><span style="color:#F8F8F2"> uChromaticAberration).b;</span></span>
<span data-line=""><span style="color:#F8F8F2">}</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6272A4">// Divide by the number of layers to normalize colors (rgb values can be worth up to the value of LOOP)</span></span>
<span data-line=""><span style="color:#F8F8F2">color </span><span style="color:#FF79C6">/=</span><span style="color:#F8F8F2"> </span><span style="color:#FF79C6">float</span><span style="color:#F8F8F2">( LOOP );</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6272A4">//...</span></span></code></pre></div><p><h2>3d world</h2>
In a 3D world, there are other things to consider:
Firstly, refraction happens at least twice, in and out. So we need to sample two times:
the <i>THREE.FrontSide</i> and the <i>THREE.BackSide</i>.
Secondly, there are reflections and diffuse lighting.</p><p><h3>backface render</h3>
Light travels in the medium and gets reflected and refracted multiple times. The ideal solution would be using ray
tracing, but it’s not feasible in real time. The least we could do is to sample two times: first, sample the back
side of the mesh with the background, then use the rendered result as texture and render with the front side. This
way, it looks more realistic.</p><figure><image src="/refraction-and-dispersion-in-three-js/backface.50.webp" class="w-4/4 my-2 mx-auto"></image><figcaption class="mt-2 text-sm text-center text-gray-500 dark:text-gray-400"><p>with backface rendering</p></figcaption></figure><figure><image src="/refraction-and-dispersion-in-three-js/no-backface.50.webp" class="w-4/4 my-2 mx-auto"></image><figcaption class="mt-2 text-sm text-center text-gray-500 dark:text-gray-400"><p>without backface rendering</p></figcaption></figure><p><h3>reflection,Specular &amp; Diffuse</h3>
I’ve talked about refractions; now, let’s talk about reflection. We already know that light bounces back from the
surface depending on the roughness of the surface and the viewing angle.</p><figure><image src="/refraction-and-dispersion-in-three-js/phong-and-blinn-phong.png" class="w-4/4 my-2 mx-auto"></image><figcaption class="mt-2 text-sm text-center text-gray-500 dark:text-gray-400"><a href="https://www.shadertoy.com/view/7tKcDW">Multiple Phong Shading Examples</a></figcaption></figure><p>There is a model called the Blinn–Phong reflection model. You can check out <a href="https://zhuanlan.zhihu.com/p/352209183">入门Shading，详解Blinn-Phong和Phong光照模型</a> or <a href="https://learnopengl.com/Advanced-Lighting/Advanced-Lighting">Advanced Lighting</a> for a better understanding.</p><h3>Fresnel effect</h3><blockquote>
<p>FRESNEL EFFECT: this effect establishes that the amount of reflected light rays that we perceive depends on the
angle at which we observe the material. A material reflects less light when we look directly at it (at an angle of 0
°, called “fresnel zero”, or F0), and reflects more light at grazing angles. For example, when we enter a lake and
look down, we can see the bottom clearly (because looking directly the water reflects very little light). If we look
at the horizon we realize that the water reflects much more light, almost like a mirror. The minimum reflectivity
value of a material, the F0, is the value that we will use on some of our maps. The PBR shader automatically
transitions between F0 and maximum reflectivity according to the angle. (source: <a href="https://luismesquita.artstation.com/blog/PwEm/everything-about-pbr-textures-and-a-little-more-part-1">everything-about-pbr-textures-and-a-little-more-part-1</a>)</p>
</blockquote><figure><image src="/refraction-and-dispersion-in-three-js/fresnel.png" class="w-4/4 my-2 mx-auto"></image></figure><p><h3>conclusion</h3>
As you can see, I didn’t give much code examples. This article means to give an glimpse of how that demo works. and
a summary of the knowledge I have acquired over the past phase. Hope you learned something.😄</p></p></div></div></div></div></body></html>